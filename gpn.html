<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Enhancer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 保持与你网站一致的样式 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F94FC',
                        dark: '#1A1A2E',
                        darker: '#16213E',
                        'dark-border': '#2A2A40',
                        'text-gray': '#8A8F98',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
        }
    </style>
</head>

<body class="bg-dark text-white font-inter min-h-screen">
    <!-- 导航栏 -->
    <nav class="bg-darker/90 backdrop-blur-md border-b border-dark-border sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="#" class="flex items-center">
                        <i class="fa fa-crop text-primary text-xl mr-2"></i>
                        <span class="font-bold text-xl">PhotoEnhance</span>
                    </a>
                </div>
                <div class="flex items-center space-x-8">
                    <a href="#tool" class="bg-primary hover:bg-primary/90 text-white px-5 py-2 rounded-lg transition-colors">Get Started</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 工具区域 -->
    <section id="tool" class="py-20 px-4">
        <div class="max-w-5xl mx-auto">
            <div class="text-center mb-12">
                <h2 class="text-[clamp(1.8rem,3vw,2.5rem)] font-bold mb-4">图片清晰化工具</h2>
                <p class="text-text-gray max-w-2xl mx-auto">上传图片，一键提升清晰度</p>
            </div>
            
            <div class="bg-darker rounded-2xl border border-dark-border p-6 md:p-8">
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <!-- 原始图片区域 -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fa fa-image mr-2 text-primary"></i>原始图片
                        </h3>
                        <div id="originalPhoto" class="border-2 border-dashed border-dark-border rounded-lg p-6 min-h-[220px] flex items-center justify-center cursor-pointer">
                            <label for="photoUpload" class="text-center w-full cursor-pointer">
                                <i class="fa fa-upload text-4xl text-text-gray mb-3 block"></i>
                                <p class="text-text-gray">点击或拖拽图片到此处</p>
                                <input type="file" id="photoUpload" accept="image/*" class="hidden">
                            </label>
                        </div>
                    </div>
                    
                    <!-- 处理后图片区域 -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fa fa-magic mr-2 text-primary"></i>处理后图片
                        </h3>
                        <div id="enhancedPhoto" class="border-2 border-dashed border-dark-border rounded-lg p-6 min-h-[220px] flex items-center justify-center">
                            <p class="text-text-gray text-center">处理后的图片将显示在这里</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-wrap justify-center gap-4 mb-6">
                    <button id="enhanceBtn" class="bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all disabled:opacity-70 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-magic mr-2"></i>开始处理
                    </button>
                    <button id="downloadBtn" class="bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all" style="display:none">
                        <i class="fa fa-download mr-2"></i>下载图片
                    </button>
                    <button id="resetBtn" class="bg-dark-border hover:bg-dark-border/80 text-white font-medium py-3 px-6 rounded-lg transition-all" disabled>
                        <i class="fa fa-refresh mr-2"></i>重置
                    </button>
                </div>
                
                <div id="status" class="bg-dark/50 p-4 rounded-lg text-sm min-h-[40px] text-text-gray">
                    状态：等待上传图片
                </div>
            </div>
        </div>
    </section>

    <script>
        // 核心变量
        const photoUpload = document.getElementById('photoUpload');
        const originalPhoto = document.getElementById('originalPhoto');
        const enhancedPhoto = document.getElementById('enhancedPhoto');
        const enhanceBtn = document.getElementById('enhanceBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const status = document.getElementById('status');
        let uploadedImage = null;
        
        // 创建两个独立画布，避免冲突
        const sourceCanvas = document.createElement('canvas');
        const sourceCtx = sourceCanvas.getContext('2d');
        const targetCanvas = document.createElement('canvas');
        const targetCtx = targetCanvas.getContext('2d');

        // 上传图片处理
        photoUpload.addEventListener('change', handlePhotoUpload);
        
        // 拖拽支持
        originalPhoto.addEventListener('dragover', (e) => {
            e.preventDefault();
            originalPhoto.classList.add('border-primary');
        });
        
        originalPhoto.addEventListener('dragleave', () => {
            originalPhoto.classList.remove('border-primary');
        });
        
        originalPhoto.addEventListener('drop', (e) => {
            e.preventDefault();
            originalPhoto.classList.remove('border-primary');
            if (e.dataTransfer.files.length) {
                photoUpload.files = e.dataTransfer.files;
                handlePhotoUpload(e);
            }
        });
        
        // 处理上传的图片
        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                // 关键：设置crossOrigin，避免画布污染
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    uploadedImage = img;
                    originalPhoto.innerHTML = '';
                    img.classList.add('max-w-full', 'max-h-[220px]', 'object-contain', 'rounded-lg');
                    originalPhoto.appendChild(img);
                    
                    // 更新状态
                    enhanceBtn.disabled = false;
                    resetBtn.disabled = false;
                    status.textContent = '状态：图片已加载，点击"开始处理"';
                    status.style.color = '#36d399';
                    enhancedPhoto.innerHTML = '<p class="text-text-gray text-center">处理后的图片将显示在这里</p>';
                    downloadBtn.style.display = 'none';
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // 重置功能
        resetBtn.addEventListener('click', () => {
            originalPhoto.innerHTML = `
                <label for="photoUpload" class="text-center w-full cursor-pointer">
                    <i class="fa fa-upload text-4xl text-text-gray mb-3 block"></i>
                    <p class="text-text-gray">点击或拖拽图片到此处</p>
                    <input type="file" id="photoUpload" accept="image/*" class="hidden">
                </label>
            `;
            enhancedPhoto.innerHTML = '<p class="text-text-gray text-center">处理后的图片将显示在这里</p>';
            uploadedImage = null;
            enhanceBtn.disabled = true;
            resetBtn.disabled = true;
            downloadBtn.style.display = 'none';
            status.textContent = '状态：等待上传图片';
            status.style.color = '';
        });

        // 清晰化处理函数（简化但稳定的版本）
        function enhanceImage(img) {
            // 设置画布尺寸（与原图一致，避免缩放问题）
            sourceCanvas.width = img.width;
            sourceCanvas.height = img.height;
            targetCanvas.width = img.width;
            targetCanvas.height = img.height;
            
            // 绘制原始图像
            sourceCtx.drawImage(img, 0, 0);
            
            // 获取图像数据
            const imageData = sourceCtx.getImageData(0, 0, img.width, img.height);
            const data = imageData.data;
            
            // 简单有效的锐化算法（避免复杂处理导致的白色问题）
            const sharpenKernel = [
                [0, -1, 0],
                [-1, 5, -1],
                [0, -1, 0]
            ];
            
            // 创建输出图像数据
            const output = sourceCtx.createImageData(img.width, img.height);
            const outputData = output.data;
            
            // 应用锐化
            for (let y = 1; y < img.height - 1; y++) {
                for (let x = 1; x < img.width - 1; x++) {
                    let r = 0, g = 0, b = 0;
                    
                    // 应用卷积核
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const index = ((y + ky) * img.width + (x + kx)) * 4;
                            r += data[index] * sharpenKernel[ky + 1][kx + 1];
                            g += data[index + 1] * sharpenKernel[ky + 1][kx + 1];
                            b += data[index + 2] * sharpenKernel[ky + 1][kx + 1];
                        }
                    }
                    
                    // 限制像素值在0-255范围内（关键：避免溢出导致的白色）
                    const idx = (y * img.width + x) * 4;
                    outputData[idx] = Math.min(255, Math.max(0, r));
                    outputData[idx + 1] = Math.min(255, Math.max(0, g));
                    outputData[idx + 2] = Math.min(255, Math.max(0, b));
                    outputData[idx + 3] = 255; // 不改变透明度
                }
            }
            
            // 将处理结果绘制到目标画布
            targetCtx.putImageData(output, 0, 0);
            return targetCanvas;
        }

        // 处理按钮点击
        enhanceBtn.addEventListener('click', () => {
            if (!uploadedImage) return;
            
            try {
                status.textContent = '状态：正在处理图片...';
                status.style.color = '#fbbf24';
                enhanceBtn.disabled = true;

                // 执行处理
                const resultCanvas = enhanceImage(uploadedImage);
                
                // 显示结果（关键：使用新的图像元素显示，避免画布直接插入的问题）
                const resultImg = new Image();
                resultImg.onload = () => {
                    enhancedPhoto.innerHTML = '';
                    resultImg.classList.add('max-w-full', 'max-h-[220px]', 'object-contain', 'rounded-lg');
                    enhancedPhoto.appendChild(resultImg);
                    
                    // 下载按钮
                    downloadBtn.style.display = 'inline-flex';
                    downloadBtn.onclick = () => {
                        const link = document.createElement('a');
                        link.href = resultCanvas.toDataURL('image/png');
                        link.download = '清晰化图片.png';
                        link.click();
                    };

                    status.textContent = '状态：处理完成';
                    status.style.color = '#36d399';
                };
                // 使用画布数据URL创建图像
                resultImg.src = resultCanvas.toDataURL('image/png');

            } catch (error) {
                console.error('处理错误:', error);
                status.textContent = '状态：处理失败，请重试';
                status.style.color = '#ff4d4f';
                enhanceBtn.disabled = false;
            }
        });

        // 点击上传区域触发选择
        originalPhoto.addEventListener('click', () => {
            if (!uploadedImage) {
                photoUpload.click();
            }
        });
    </script>
</body>
</html>

