<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片高清化工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 更换为更稳定的库版本 -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upscaler@1.0.0-beta.24/dist/upscaler.min.js"></script>
    
    <style>
        body { background: #1A1A2E; color: #e5e7eb; }
        .card { background: #16213E; border: 1px solid #2A2A40; border-radius: 12px; padding: 20px; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; }
        .btn-primary { background: #4F94FC; color: white; }
        .btn-primary:disabled { background: #4F94FC80; cursor: not-allowed; }
        .image-area { border: 2px dashed #2A2A40; border-radius: 8px; min-height: 200px; display: flex; align-items: center; justify-content: center; padding: 16px; }
    </style>
</head>
<body class="p-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold text-center mb-6">图片高清化工具</h1>
        
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="card">
                <h3 class="mb-3">原始图片</h3>
                <div id="original" class="image-area">
                    <label for="upload">
                        <i class="fa fa-upload text-3xl text-gray-500"></i>
                        <p>点击上传图片</p>
                        <input type="file" id="upload" accept="image/*" class="hidden">
                    </label>
                </div>
            </div>
            
            <div class="card">
                <h3 class="mb-3">处理后图片</h3>
                <div id="result" class="image-area">
                    <p>处理结果将显示在这里</p>
                </div>
            </div>
        </div>
        
        <div class="flex justify-center gap-4 mb-4">
            <button id="process" class="btn btn-primary" disabled>开始处理</button>
            <button id="download" class="btn btn-primary" style="display:none">下载图片</button>
        </div>
        
        <div id="log" class="bg-darkgray p-4 rounded-lg text-sm min-h-[40px]">
            状态：等待上传图片
        </div>
    </div>

    <script>
        const upload = document.getElementById('upload');
        const original = document.getElementById('original');
        const result = document.getElementById('result');
        const processBtn = document.getElementById('process');
        const downloadBtn = document.getElementById('download');
        const log = document.getElementById('log');
        let imgElement = null;

        // 上传图片
        upload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    imgElement = img;
                    original.innerHTML = '';
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '200px';
                    original.appendChild(img);
                    processBtn.disabled = false;
                    log.textContent = '状态：图片已加载，可点击处理';
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // 处理图片
        processBtn.addEventListener('click', async () => {
            if (!imgElement) return;
            
            try {
                log.textContent = '状态：加载模型中...';
                processBtn.disabled = true;

                // 使用官方推荐的轻量模型（更小、加载更快）
                const upscaler = new Upscaler({
                    model: {
                        path: 'https://cdn.jsdelivr.net/npm/@upscalerjs/esrgan-slim@1.0.0-alpha.12/model.json',
                        scale: 2
                    }
                });

                log.textContent = '状态：开始处理图片...';
                const start = Date.now();
                const output = await upscaler.upscale(imgElement); // 直接输出图片元素
                const end = Date.now();

                // 显示结果
                result.innerHTML = '';
                output.style.maxWidth = '100%';
                output.style.maxHeight = '200px';
                result.appendChild(output);

                // 准备下载
                downloadBtn.style.display = 'inline-block';
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = output.src;
                    a.download = 'enhanced-image.png';
                    a.click();
                };

                log.textContent = `状态：处理完成，耗时 ${(end - start)/1000} 秒`;
            } catch (err) {
                // 详细错误日志（关键！）
                log.textContent = `错误：${err.message || '未知错误'}`;
                console.error('处理错误详情：', err); // 控制台会显示完整错误
                processBtn.disabled = false; // 允许重试
            }
        });
    </script>
</body>
</html>

